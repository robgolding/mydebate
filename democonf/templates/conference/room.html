{% extends 'conference/base.html' %}

{% block title-inner %}{{room.tite}} | {{block.super}}{% endblock title-inner %}

{% block js-inner %}

{{block.super}}

	function refreshData(unread) {
		if (typeof unread == 'undefined') unread = false;
		
		var url = "{% url conference_room room.pk %}?json"
		if (unread) {
			url += "&unread"
		} else {
			$("#messages").html("Loading...");
		}
		
		$.getJSON(url, function(data, textStatus){
			
			if (!unread) $("#messages").html("");
			
			$.each(data.messages, function(i, item){
				$("#messages").append("<p><b>"+item['author']+":</b> "+item['content']+"</p>");
			});
			
			$("#members").html("");
			$.each(data.members, function(i, item){
				$("#members").append("<p><b>"+item['username']+"</b></p>");
			});
			
			if (unread)
			{
				if (data['messages'].length > 0)
				{
					$("#messages").animate({ scrollTop: $("#messages").attr("scrollHeight") }, 500);
				}
			} else {
				$("#messages").attr({ scrollTop: $("#messages").attr("scrollHeight") });
			}
		});
	}
	
	$(document).ready(function() {
		$("#input").focus();
		refreshData();
		setInterval("refreshData(true)", 2000);
		
		$("#message-input-form").submit(function() {
			$("#input").attr("DISABLED", "disabled");
			$("#submit").attr("DISABLED", "disabled");

			var message = $("input[name='message']");
			
			var data = "message=" + message.val();
			
			$.ajax({
				url: "{{ room.get_absolute_url }}",
				type: "POST",
				data: data,
				cache: false,
				success: function(html) {
					$("input[name='message']").val("");
					refreshData(true);
					$("#input").removeAttr("disabled");
					$("#submit").removeAttr("disabled");
					$("#input").focus();
				}
			});
			return false;
		});
	});

{% endblock js-inner %}
		
{% block body-inner %}

	<h3>{{room}}</h3>
	
	<div id="messages"></div>
	<div id="members"></div>
	
	<form id="message-input-form" method="POST" action="{% url conference_room room.id %}">
		<input type="text" id="input" name="message" size="40" />
		<input type="submit" id="submit" value="Submit" />
	</form>
	<a id="leave_button" href="{% url conference_room_leave room.id %}">Leave Conference</a>
	
{% endblock body-inner %}
